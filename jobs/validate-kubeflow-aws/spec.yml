plan:
  - env:
      - CONTAINER=validate-aws
      - STORAGE=validate-aws-storage
      - JUJU_SNAP_CHANNEL=edge
      - REGION=us-east-2
      - BUNDLE_REVISION=master
    before-script:
      - |
        #!/bin/bash

        set -x

        sudo lxc profile copy default aws 2>&1 || true
        sudo lxc profile edit aws < jobs/validate-kubeflow-aws/lxc.profile 2>&1
        sudo lxc launch -p default -p aws ubuntu:18.04 "$CONTAINER" 2>&1
        sudo lxc file push -p ~/.local/share/juju/credentials.yaml "$CONTAINER"/root/.local/share/juju/credentials.yaml 2>&1

        cat >kubeflow-deploy<<EOF
        #!/bin/bash
        sudo snap install core
        sudo snap install charm --classic
        sudo snap install jq
        sudo snap install juju --classic --channel $JUJU_SNAP_CHANNEL
        sudo snap install juju-helpers --classic --edge
        sudo snap install juju-wait --classic
        sudo snap install kubectl --classic
        sudo snap install yq
        sudo apt update && sudo apt install -y libssl-dev python3-pip
        sudo pip3 install pytest sh kfp requests pyyaml

        git clone https://github.com/juju-solutions/bundle-kubeflow.git
        cd bundle-kubeflow && \
             git checkout "$BUNDLE_REVISION" && \
             ./scripts/manage-cdk create --region "$REGION" &&
             ./scripts/deploy-cdk create --build --ci

        cd bundle-kubeflow && git checkout "$BUNDLE_REVISION" && ./tests/run.sh
        EOF
        chmod +x kubeflow-deploy
        sudo lxc file push -p kubeflow-cleanup "$CONTAINER"/root/kubeflow-deploy 2>&1
        sudo lxc exec "$CONTAINER" -- bash -c '/root/kubeflow-deploy' 2>&1


    after-script:
      - |
        #!/bin/bash

        set -x

        cat >kubeflow-cleanup<<EOF
        #!/bin/bash
        pods=`juju kubectl get pods -l workflows.argoproj.io/completed="true" -o custom-columns=:metadata.name --no-headers || echo -n ""`
        for pod in $pods; do
            echo "===>" $pod main "<==="
            juju kubectl logs -c main --timestamps $pod || true
            printf '\n'
            echo "===>" $pod wait "<==="
            juju kubectl logs -c wait --timestamps $pod || true
            printf '\n\n'
        done
        juju kubectl logs --tail 1000 --all-containers -l juju-app=argo-controller 2>&1
        juju kubectl get pods 2>&1
        juju kubectl get pods -oyaml 2>&1
        juju status  2>&1 || true
        juju status --format yaml 2>&1 || true
        juju list-controllers 2>&1 || true
        juju list-models 2>&1 || true
        juju destroy-model cdkkf:kubeflow -y --destroy-storage --force 2>&1 || true
        juju destroy-controller -y --destroy-all-models --destroy-storage cdkkf 2>&1 || true
        EOF

        chmod +x kubeflow-cleanup
        sudo lxc file push -p kubeflow-cleanup "$CONTAINER"/root/kubeflow-cleanup
        sudo lxc exec "$CONTAINER" -- bash -c '/root/kubeflow-cleanup'
        sudo lxc delete --force "$CONTAINER"

        # Data collection
        python3 jobs/infra/collect-debug.py push 'build_log' ogc.log
        python3 jobs/infra/collect-debug.py push 'metadata' metadata.json
        python3 jobs/infra/collect-debug.py push 'job_result' *job.json
        python3 jobs/infra/collect-debug.py set-key 'juju_snap_channel' "$JUJU_SNAP_CHANNEL"
        python3 jobs/infra/collect-debug.py set-key 'juju_version' $(juju version)
        python3 jobs/infra/collect-debug.py save-meta metadata.json

meta:
  name: Verify CK with Kubeflow
  description: |
    Verifies CK with Kubeflow
  mkdocs:
    destination:
      - "validations/ck/kubeflow.md"
    jenkins-job-builder:
      jobs:
        - jobs/ci-master.yaml
        - jobs/validate-kubeflow-aws.yaml
