# Validates a deployed CDK

# V2 ------------------------------------------------------------------------- #
- job:
    name: 'validate-ck'
    node: runner-validate
    description: |
      Validates CDK edge on amd64 and arm64, supports last three recent releases additionally
      validates upgrades from current stables to latest edge.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 3
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-env:
          COMMAND: |
            parallel --ungroup bash jobs/validate/spec {1} {2} {3} {4} ::: 1.19/edge 1.18/edge 1.17/edge 1.16/edge ::: focal bionic xenial ::: edge ::: arm64 amd64
            parallel --ungroup bash jobs/validate/upgrade-spec {1} {2} {3} {4} ::: 1.18/stable 1.17/stable 1.16/stable ::: focal bionic xenial ::: edge ::: arm64 amd64

- job:
    name: 'validate-ck-snapd-upgrade'
    node: runner-validate
    description: |
      Validates CK release using an upgrade snapcore.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 7
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-env:
          COMMAND: |
            parallel --ungroup bash jobs/validate/snapd-upgrade-spec {1} {2} ::: 1.19/edge 1.18/edge 1.17/edge 1.16/edge ::: focal bionic xenial


- job:
    name: 'validate-ck-series-upgrade'
    node: runner-validate
    description: |
      Validates CK machine series upgrades.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    triggers:
        - timed: "@weekly"
    properties:
      - build-discarder:
          num-to-keep: 7
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-venv:
          JOB_SPEC_DIR: "jobs/validate"
          COMMAND: |
            venv/bin/python -m pip install https://github.com/battlemidget/ogc/archive/master.zip
            venv/bin/ogc --spec jobs/validate/series-upgrade-spec.yml


# ADDONS --------------------------------------------------------------------- #
- job:
    name: 'validate-ck-localhost'
    node: runner-validate
    description: |
      Validates CDK edge, supports last three recent releases on localhost.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 7
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-venv:
          JOB_SPEC_DIR: "jobs/validate"
          COMMAND: |
            venv/bin/python -m pip install https://github.com/battlemidget/ogc/archive/master.zip
            venv/bin/ogc --spec jobs/validate/localhost-spec.yml

- job:
    name: 'validate-ck-s390x'
    node: runner-validate
    description: |
      Validates CDK edge, supports last three recent releases on s390x localhost.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 7
    # triggers:
    #     - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-venv:
          JOB_SPEC_DIR: "jobs/validate"
          COMMAND: |
            venv/bin/python -m pip install https://github.com/battlemidget/ogc/archive/master.zip
            venv/bin/ogc --spec jobs/validate/ck-s390-spec.yml


- job:
    name: 'validate-ck-calico'
    description: |
      Validates CK, with calico.
    node: runner-validate
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 7
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-venv:
          JOB_SPEC_DIR: "jobs/validate"
          COMMAND: |
            venv/bin/python -m pip install https://github.com/battlemidget/ogc/archive/master.zip
            venv/bin/ogc --spec jobs/validate/calico-spec.yml

- job:
    name: 'validate-ck-tigera-secure-ee'
    description: |
      Validates CK, with tigera.
    node: runner-validate
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-blocker:
          use-build-blocker: true
          blocking-jobs:
            - ".*calico.*"
          block-level: 'GLOBAL'
          queue-scanning: 'ALL'
      - build-discarder:
          num-to-keep: 7
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-venv:
          JOB_SPEC_DIR: "jobs/validate"
          COMMAND: |
            venv/bin/python -m pip install https://github.com/battlemidget/ogc/archive/master.zip
            venv/bin/ogc --spec jobs/validate/tigera-ee-spec.yml

- job:
    name: 'validate-ck-vault'
    node: runner-validate
    description: |
      Validates CK, with vault.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 3
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-env:
          COMMAND: |
            parallel --ungroup bash jobs/validate/vault-spec {1} {2} ::: 1.19/edge 1.18/edge 1.17/edge 1.16/edge ::: focal bionic xenial

- job:
    name: 'validate-ck-ceph'
    node: runner-validate
    description: |
      Validates CK, with Ceph.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 3
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-env:
          COMMAND: |
            parallel --ungroup bash jobs/validate/ceph-spec {1} {2} ::: 1.19/edge 1.18/edge 1.17/edge 1.16/edge ::: focal bionic

- job:
    name: 'validate-ck-nfs'
    node: runner-validate
    description: |
      Validates CK, with NFS.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 7
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-env:
          COMMAND: |
            parallel --ungroup bash jobs/validate/nfs-spec {1} {2} ::: 1.19/edge 1.18/edge 1.17/edge 1.16/edge ::: focal bionic xenial


- job:
    name: 'validate-ck-nvidia'
    node: runner-validate
    description: |
      Validates CK, with NVidia.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 3
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-env:
          COMMAND: |
            parallel --ungroup bash jobs/validate/nvidia-spec {1} {2} ::: 1.19/edge 1.18/edge 1.17/edge 1.16/edge ::: focal bionic xenial


- job:
    name: 'validate-ck-aws-iam'
    description: |
      Validates CK, with AWS IAM.
    node: runner-validate
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 7
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-venv:
          JOB_SPEC_DIR: "jobs/validate"
          COMMAND: |
            venv/bin/python -m pip install https://github.com/battlemidget/ogc/archive/master.zip
            venv/bin/ogc --spec jobs/validate/aws-iam-spec.yml


- job:
    name: 'validate-ck-nagios'
    description: |
      Validates CK, with Nagios.
    node: runner-validate
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 7
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-env:
          COMMAND: |
            parallel --ungroup bash jobs/validate/nagios-spec {1} {2} ::: 1.19/edge 1.18/edge 1.17/edge 1.16/edge ::: focal bionic xenial

- job:
    name: 'validate-ck-multus'
    node: runner-amd64
    description: |
      Validates CK, with Multus.
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    properties:
      - build-discarder:
          num-to-keep: 7
    triggers:
        - timed: "@daily"
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/validate"
      - run-venv:
          JOB_SPEC_DIR: "jobs/validate"
          COMMAND: |
            venv/bin/python -m pip install https://github.com/battlemidget/ogc/archive/master.zip
            venv/bin/ogc --spec jobs/validate/multus-spec.yml
