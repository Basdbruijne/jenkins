sequential: yes

plan:
  - &BASE_JOB
    env:
      - SNAP_VERSION=1.17/stable
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=edge
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-snapd-upgrade
      - JUJU_MODEL=validate-snapd-upgrade-model
      - TEST_UPGRADE_SNAPD_CHANNEL=beta
    if: '[[ $(date +"%A") != "Sunday" ]] && [[ $(date +"%A") != "Saturday" ]]'
    script:
      - juju kill-controller -y $JUJU_CONTROLLER || true
      - runner:
          timeout: 7200
          script: |
            #!/bin/bash
            set -x

            sudo snap refresh core --$TEST_UPGRADE_SNAPD_CHANNEL 2>&1

            juju destroy-controller -y --destroy-all-models --destroy-storage $JUJU_CONTROLLER --debug 2>&1

            juju bootstrap $JUJU_CLOUD $JUJU_CONTROLLER \
               -d $JUJU_MODEL --model-default test-mode=true \
               --model-default resource-tags=owner=k8sci \
               --bootstrap-constraints 'arch=amd64' 2>&1

            cat > overlay.yaml <<EOF
            applications:
              kubernetes-master:
                options:
                  channel: $SNAP_VERSION
              kubernetes-worker:
                options:
                  channel: $SNAP_VERSION
            EOF

            pytest -m "not slow" $INTEGRATION_TEST_PATH/validation.py \
                 --cloud $JUJU_CLOUD \
                 --controller $JUJU_CONTROLLER \
                 --model $JUJU_MODEL \
                 --snapd-upgrade \
                 --snapd-channel $TEST_UPGRADE_SNAPD_CHANNEL
    after-script:
      - !include jobs/spec-helpers/collect.yml
      - juju destroy-controller -y --destroy-all-models --destroy-storage $JUJU_CONTROLLER
      - runner:
          description: Reset snapd core to stable
          script: |
            #!/bin/bash
            sudo snap refresh core --stable
          wait-for-success: yes
          back-off: 5
          retries: 5
  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.18/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=edge
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-snapd-upgrade
      - JUJU_MODEL=validate-snapd-upgrade-model
      - TEST_UPGRADE_SNAPD_CHANNEL=beta

meta:
  name: Verify CK with Snapd upgrade
  description: |
    Verifies that CK passes when the underlying snap core (snapd) is upgraded to
    a candidate/test/beta channel.
  mkdocs:
    destination:
      - "validations/ck/snapd-upgrade.md"
    jenkins-job-builder:
      job: ../validate.yaml
      name: validate-ck-snapd-upgrade
