meta:
  name: Verify CK with Tigera
  description: |
    Verifies that CK with Tigera passes integration tests
  mkdocs:
    destination:
      - "validations/ck/tigera-ee.md"

plan:
  - &BASE_JOB
    env:
      - SNAP_VERSION=1.16/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/kubernetes-tigera-secure-ee
      - JUJU_DEPLOY_CHANNEL=edge
      - JUJU_CLOUD=aws/us-east-2
      - JUJU_CONTROLLER=validate-tigera
      - JUJU_MODEL=validate-tigera-model
    before-script:
      - juju destroy-controller -y --destroy-all-models --destroy-storage $JUJU_CONTROLLER --debug
      - python3 jobs/integration/tigera_aws.py cleanup
      - python3 jobs/integration/tigera_aws.py bootstrap
      - juju deploy $JUJU_DEPLOY_BUNDLE --overlay jobs/overlays/1.16-edge-overlay.yaml --channel edge
      - |
        #!/bin/bash
        set -eux
        juju config -m $JUJU_CONTROLLER:$JUJU_MODEL tigera-secure-ee \
            license-key=$(base64 -w0 $TIGERA_SECURE_EE_LICENSE_KEY_FILE) \
            registry-credentials=$(base64 -w0 $TIGERA_PRIVATE_REGISTRY_CREDENTIALS_FILE)
      - python3 jobs/integration/tigera_aws.py disable-source-dest-check
      - juju-wait -e $JUJU_CONTROLLER:$JUJU_MODEL -w
    script:
      - |
        #!/bin/bash
        set -eux
        pytest $INTEGRATION_TEST_PATH/validation.py \
             --cloud $JUJU_CLOUD \
             --model $JUJU_MODEL \
             --controller $JUJU_CONTROLLER
    after-script:
      - wget https://raw.githubusercontent.com/juju-solutions/cdk-field-agent/master/collect.py
      - python3 collect.py -m $JUJU_CONTROLLER:$JUJU_MODEL
      - python3 jobs/infra/collect-debug.py push 'cdk_field_agent' results*.tar.gz
      - python3 jobs/infra/collect-debug.py push 'build_log' ogc.log
      - python3 jobs/infra/collect-debug.py push 'metadata' metadata.json
      - python3 jobs/infra/collect-debug.py push 'job_result' *job.json
      - python3 jobs/infra/collect-debug.py set-key 'snap_version' "$SNAP_VERSION"
      - python3 jobs/infra/collect-debug.py save-meta metadata.json
      - juju destroy-controller -y --destroy-all-models --destroy-storage $JUJU_CONTROLLER --debug

  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.15/edge
      - JUJU_DEPLOY_BUNDLE=kubernetes-tigera-secure-ee
  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.14/edge
      - JUJU_DEPLOY_BUNDLE=kubernetes-tigera-secure-ee
  - <<: *BASE_JOB
    env:
      - JUJU_DEPLOY_BUNDLE=kubernetes-tigera-secure-ee
      - SNAP_VERSION=1.13/edge
