sequential: yes

plan:
  - &BASE_JOB
    env:
      - SNAP_VERSION=1.18/edge
      - JUJU_DEPLOY_CHARM=ubuntu
      - JUJU_DEPLOY_CHANNEL=stable
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-localhost
      - JUJU_MODEL=validate-localhost
    # if: '[[ $(date +"%A") != "Sunday" ]] && [[ $(date +"%A") != "Saturday" ]]'
    before-script:
      - juju kill-controller -y $JUJU_CONTROLLER || true
      - python3 jobs/infra/collect-debug.py set-key 'job_name_custom' "$JUJU_CONTROLLER-"$(uname -m)
      - juju:
          cloud: $JUJU_CLOUD
          controller: $JUJU_CONTROLLER
          model: $JUJU_MODEL
          bootstrap:
            debug: no
            replace-controller: yes
            model-default:
              - test-mode=true
              - resource-tags=owner=k8sci
          deploy:
            charm: $JUJU_DEPLOY_CHARM
            constraints: "mem=32G root-disk=100G cores=32"
            wait: yes
            timeout: 7200
            channel: $JUJU_DEPLOY_CHANNEL
    script:
      - |
        #!/bin/bash

        set -x
        unitAddress()
        {
            py_script="
        import sys
        import yaml

        status_yaml=yaml.safe_load(sys.stdin)
        unit = status_yaml['applications']['$1']['units']
        units = list(unit.keys())
        print(unit[units[0]]['public-address'])
        "
            juju status -m "$JUJU_CONTROLLER:$JUJU_MODEL" "$1" --format yaml | env python3 -c "$py_script"
        }


        ansible-playbook -i $(unitAddress ubuntu), \
                     --ssh-common-args '-o StrictHostKeyChecking=no' \
                     --key-file /var/lib/jenkins/.local/share/juju/ssh/juju_id_rsa \
                     -u ubuntu \
                     jobs/validate/playbooks/single-system.yml

        tee setup <<EOF
        #!/bin/bash
        set -x
        export PATH=/snap/bin:$PATH
        git clone https://github.com/charmed-kubernetes/jenkins
        pushd jenkins
        sudo pip3 install -rrequirements.txt

        juju bootstrap localhost/localhost $JUJU_CONTROLLER -d $JUJU_MODEL
        juju deploy -m "$JUJU_CONTROLLER":"$JUJU_MODEL" cs:~containers/charmed-kubernetes
        juju-wait -e $JUJU_CONTROLLER:$JUJU_MODEL -w

        pytest -m "not slow" jobs/integration/validation.py \
            --cloud localhost/localhost \
            --model $JUJU_MODEL \
            --controller $JUJU_CONTROLLER
        popd
        EOF

        chmod +x setup
        juju scp -m "$JUJU_CONTROLLER":"$JUJU_MODEL" setup ubuntu/0:setup
        juju ssh -m "$JUJU_CONTROLLER":"$JUJU_MODEL" --pty=true ubuntu/0 -- 'bash setup'

      # - !include jobs/spec-helpers/pytest.yml
    after-script:
      # - !include jobs/spec-helpers/collect.yml
      - juju destroy-controller -y --destroy-all-models --destroy-storage $JUJU_CONTROLLER
  # - <<: *BASE_JOB
  #   env:
  #     - SNAP_VERSION=1.17/stable
  #     - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
  #     - JUJU_DEPLOY_CHANNEL=stable
  #     - JUJU_CLOUD=localhost/localhost
  #     - JUJU_CONTROLLER=validate-ck-localhost
  #     - JUJU_MODEL=validate-model-localhost
  # - <<: *BASE_JOB
  #   env:
  #     - SNAP_VERSION=1.17/edge
  #     - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
  #     - JUJU_DEPLOY_CHANNEL=stable
  #     - JUJU_CLOUD=localhost/localhost
  #     - JUJU_CONTROLLER=validate-ck-localhost
  #     - JUJU_MODEL=validate-model-localhost
  # - <<: *BASE_JOB
  #   env:
  #     - SNAP_VERSION=1.18/edge
  #     - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
  #     - JUJU_DEPLOY_CHANNEL=edge
  #     - JUJU_CLOUD=localhost/localhost
  #     - JUJU_CONTROLLER=validate-ck-localhost
  #     - JUJU_MODEL=validate-model-localhost
  #   script:
  #     - !include jobs/spec-helpers/pytest-slow.yml
  #   if: '[[ $(date +"%A") = "Saturday" ]]'
  # - <<: *BASE_JOB
  #   env:
  #     - SNAP_VERSION=1.16/edge
  #     - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
  #     - JUJU_DEPLOY_CHANNEL=edge
  #     - JUJU_CLOUD=localhost/localhost
  #     - JUJU_CONTROLLER=validate-ck-localhost
  #     - JUJU_MODEL=validate-model-localhost
  #   if: '[[ $(date +"%A") = "Saturday" ]]'
  # - <<: *BASE_JOB
  #   env:
  #     - SNAP_VERSION=1.15/edge
  #     - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
  #     - JUJU_DEPLOY_CHANNEL=edge
  #     - JUJU_CLOUD=localhost/localhost
  #     - JUJU_CONTROLLER=validate-ck-localhost
  #     - JUJU_MODEL=validate-model-localhost
  #   if: '[[ $(date +"%A") = "Sunday" ]]'

meta:
  name: Verify CK on Localhost
  description: |
    Verifies that CK on localhost passes integration tests for all architectures
  mkdocs:
    destination:
      - "validations/ck/index.md"
    jenkins-job-builder:
      jobs:
        - jobs/ci-master.yaml
        - jobs/validate.yaml
