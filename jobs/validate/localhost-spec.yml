meta:
  name: Verify CK on Localhost
  description: |
    Verifies that CK on localhost passes integration tests
  mkdocs:
    destination:
      - "validations/ck/localhost.md"

matrix:
  snap_version:
    - 1.18/edge
    - 1.17/edge
    - 1.16/edge
    - 1.15/edge
  series:
    - focal
    - bionic
    - xenial
  channel:
    - edge

concurrent: no

plan:
  post-execute: |
    #!/bin/bash
    set -x
    export JUJU_CONTROLLER=$(ogc-collect get-key juju_controller)
    export JUJU_MODEL=$(ogc-collect get-key juju_model)

    juju ssh -m "$JUJU_CONTROLLER":"$JUJU_MODEL" --pty=true ubuntu/0 -- wget https://raw.githubusercontent.com/juju-solutions/cdk-field-agent/master/collect.py
    juju ssh -m "$JUJU_CONTROLLER":"$JUJU_MODEL" --pty=true ubuntu/0 -- python3 collect.py -m $JUJU_CONTROLLER:$JUJU_MODEL

    juju scp -m "$JUJU_CONTROLLER":"$JUJU_MODEL" ubuntu/0:results*.tar.gz . || true

    ogc-collect set-key 'snap_version' "$SNAP_VERSION"
    ogc-collect set-key 'juju_deploy_channel' "$JUJU_DEPLOY_CHANNEL"

    juju destroy-controller -y --destroy-all-models --destroy-storage $(ogc-collect get-key juju_controller)

  execute: |
    #!/bin/bash

    set -eux

    export JUJU_CONTROLLER=validate-localhost"-$(ogc-collect get-key job_id | cut -f1 -d-)"
    export JUJU_MODEL=validate-localhost-"$SERIES-$(ogc-collect get-key job_id | cut -f1 -d-)"
    export JUJU_DEPLOY_CHANNEL=edge


    unitAddress()
    {
        py_script="
    import sys
    import yaml

    status_yaml=yaml.safe_load(sys.stdin)
    unit = status_yaml['applications']['$1']['units']
    units = list(unit.keys())
    print(unit[units[0]]['public-address'])
    "
        juju status -m "$JUJU_CONTROLLER:$JUJU_MODEL" "$1" --format yaml | env python3 -c "$py_script"
    }

    ogc-collect set-key 'juju_controller' "$JUJU_CONTROLLER"
    ogc-collect set-key 'juju_model' "$JUJU_MODEL"
    ogc-collect set-key 'job_name_custom' "validate-ck-localhost-$SERIES-$SNAP_VERSION"
    juju bootstrap aws/us-east-2 $JUJU_CONTROLLER \
         -d $JUJU_MODEL \
         --bootstrap-series $SERIES \
         --force \
         --bootstrap-constraints arch="amd64" \
         --model-default test-mode=true \
         --model-default resource-tags=owner=k8sci \
         --model-default image-stream=daily

    juju deploy -m $JUJU_CONTROLLER:$JUJU_MODEL \
        --series $SERIES \
        --force \
        --constraints "mem=32G root-disk=100G cores=16" \
        ubuntu

    juju-wait -e $JUJU_CONTROLLER:$JUJU_MODEL -w


    ansible-playbook -i $(unitAddress ubuntu), \
                     --ssh-common-args '-o StrictHostKeyChecking=no' \
                     --key-file /var/lib/jenkins/.local/share/juju/ssh/juju_id_rsa \
                     -u ubuntu \
                     $WORKSPACE/jobs/validate/playbooks/single-system.yml


    tee overlay.yaml <<EOF> /dev/null
    series: $SERIES
    applications:
      kubernetes-master:
        options:
          channel: $SNAP_VERSION
      kubernetes-worker:
        options:
          channel: $SNAP_VERSION
    EOF


    tee setup <<EOF> /dev/null
    #!/bin/bash
    set -x
    export PATH=/snap/bin:$PATH

    juju bootstrap localhost/localhost \
        $JUJU_CONTROLLER \
        -d $JUJU_MODEL \
        --bootstrap-series $SERIES \
        --force \
        --model-default image-stream=daily 1>&2

    juju deploy -m "$JUJU_CONTROLLER":"$JUJU_MODEL" \
        --channel $JUJU_DEPLOY_CHANNEL \
        --force \
        --overlay overlay.yaml \
        cs:~containers/charmed-kubernetes 1>&2

    juju-wait -e $JUJU_CONTROLLER:$JUJU_MODEL -w

    pushd jenkins
    timeout 45m pytest -m "not slow" jobs/integration/validation.py \
        --cloud localhost/localhost \
        --model $JUJU_MODEL \
        --controller $JUJU_CONTROLLER
    popd

    EOF

    chmod +x setup
    juju scp -m "$JUJU_CONTROLLER":"$JUJU_MODEL" setup ubuntu/0:setup
    juju scp -m "$JUJU_CONTROLLER":"$JUJU_MODEL" overlay.yaml ubuntu/0:overlay.yaml
    juju ssh -m "$JUJU_CONTROLLER":"$JUJU_MODEL" --pty=true ubuntu/0 -- 'bash setup'
