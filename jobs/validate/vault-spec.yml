sequential: yes

plan:
  - &BASE_JOB
    env:
      - SNAP_VERSION=1.18/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=edge
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-vault
      - JUJU_MODEL=validate-vault
    if: '[[ $(date +"%A") != "Sunday" ]] && [[ $(date +"%A") != "Saturday" ]]'
    before-script:
      - juju:
          cloud: $JUJU_CLOUD
          controller: $JUJU_CONTROLLER
          model: $JUJU_MODEL
          bootstrap:
            constraints: "arch=amd64"
            debug: no
            replace-controller: yes
            config:
              - vpc-id=vpc-0e4f11d0d4e9ba35f
            model-default:
              - test-mode=true
              - resource-tags=owner=k8sci
              - vpc-id=vpc-0e4f11d0d4e9ba35f
          deploy:
            reuse: no
            bundle: $JUJU_DEPLOY_BUNDLE
            overlay: |
              applications:
                kubernetes-master:
                  options:
                    channel: $SNAP_VERSION
                kubernetes-worker:
                  options:
                    channel: $SNAP_VERSION
            wait: yes
            timeout: 7200
            channel: $JUJU_DEPLOY_CHANNEL
    script:
      - !include jobs/spec-helpers/pytest.yml
    after-script:
      - !include jobs/spec-helpers/collect.yml
      - juju destroy-controller -y --destroy-all-models --destroy-storage $JUJU_CONTROLLER
  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.17/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=edge
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-vault
      - JUJU_MODEL=validate-vault
  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.17/stable
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=edge
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-vault
      - JUJU_MODEL=validate-vault
  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.16/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=edge
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-vault
      - JUJU_MODEL=validate-vault
    if: '[[ $(date +"%A") = "Saturday" ]]'
  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.15/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=edge
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-vault
      - JUJU_MODEL=validate-vault
    if: '[[ $(date +"%A") = "Sunday" ]]'

meta:
  name: Verify CK with Vault
  description: |
    Verifies that CK with Vault passes integration tests
  long-description: |
    ## Requirements

    A valid AWS VPC must be created prior to running this test with a single
    subnet. That VPC-ID is then passed to the bootstrap config and
    model-defaults during the run.

    See: https://old-docs.jujucharms.com/2.5/en/charms-fan-aws-vpc
  mkdocs:
    destination:
      - "validations/ck/vault.md"
    jenkins-job-builder:
      jobs:
        - jobs/ci-master.yaml
