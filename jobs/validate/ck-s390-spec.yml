meta:
  name: Verify CK on s390x
  description: |
    Verifies that CK on s390x localhost passes integration tests
  mkdocs:
    destination:
      - "validations/ck/s390x.md"

matrix:
  snap_version:
    - 1.18/edge
    - 1.17/edge
    - 1.16/edge
    - 1.15/edge
  series:
    - focal
    - bionic
    - xenial
  channel:
    - edge

plan:
  env:
    - JUJU_CONTROLLER=validate-ck-s390x
    - JUJU_MODEL=validate-s390x
    - JUJU_CLOUD=us-east-2
    - JUJU_DEPLOY_CHANNEL=$CHANNEL
  pre-execute: |
    #!/bin/bash
    . $WORKSPACE/cilib.sh

    setup_env
  post-execute: |
    #!/bin/bash
    set -x

    . $WORKSPACE/cilib.sh

    inject_env

    ssh -tt ubuntu@$S3LP3 -- /snap/bin/juju-crashdump -s -a debug-layer -a config -m "$JUJU_CONTROLLER:$JUJU_MODEL"

    scp -r ubuntu@$S3LP3:*.log . || true
    scp -r ubuntu@$S3LP3:juju-crashdump* . || true

    teardown_env

  execute: |
    #!/bin/bash
    set -eu

    . $WORKSPACE/cilib.sh

    inject_env

    export JUJU_DEPLOY_CHANNEL=edge

    ansible-playbook -i $S3LP3, \
                     --ssh-common-args '-o StrictHostKeyChecking=no' \
                     --key-file $CDKBOTSSHCREDS \
                     -u ubuntu \
                     $WORKSPACE/jobs/validate/playbooks/single-system.yml


    tee overlay.yaml <<EOF> /dev/null
    series: $SERIES
    applications:
      kubernetes-master:
        options:
          channel: $SNAP_VERSION
      kubernetes-worker:
        options:
          channel: $SNAP_VERSION
    EOF


    tee setup <<EOF> /dev/null
    #!/bin/bash
    set -eux
    export PATH=/snap/bin:$PATH

    juju bootstrap localhost/localhost \
        $JUJU_CONTROLLER \
        -d $JUJU_MODEL \
        --bootstrap-series $SERIES \
        --force \
        --model-default image-stream=daily 1>&2

    juju deploy -m "$JUJU_CONTROLLER":"$JUJU_MODEL" \
        --channel $JUJU_DEPLOY_CHANNEL \
        --force \
        --overlay overlay.yaml \
        cs:~containers/charmed-kubernetes 1>&2

    timeout 45m juju-wait -e $JUJU_CONTROLLER:$JUJU_MODEL -w

    pushd jenkins
    timeout 2h pytest --instafail \
        --html=$OGC_JOB_WORKDIR/report.html --self-contained-html \
        jobs/integration/validation.py \
        --cloud localhost/localhost \
        --model $JUJU_MODEL \
        --controller $JUJU_CONTROLLER
    popd

    EOF

    chmod +x setup
    ssh -tt ubuntu@$S3LP3 -- setup ubuntu/0:setup
    scp overlay.yaml ubuntu@$S3LP3:overlay.yaml
    ssh -tt ubuntu@$S3LP3 -- 'bash setup'
