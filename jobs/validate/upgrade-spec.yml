plan:
  - &BASE_JOB
    env:
      - SNAP_VERSION=1.14/stable
      - SNAP_VERSION_UPGRADE_TO=1.17/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=stable
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-upgrade
      - JUJU_MODEL=validate-upgrade-model
    if: '[[ $(date +"%A") != "Sunday" ]] && [[ $(date +"%A") != "Saturday" ]]'
    before-script:
      - juju kill-controller -y $JUJU_CONTROLLER || true
      - !include jobs/spec-helpers/bootstrap.yml
    script:
      - |
        #!/bin/bash
        set -x
        pytest -m "not slow" "$INTEGRATION_TEST_PATH"/validation.py \
           --upgrade-snap-channel "$SNAP_VERSION_UPGRADE_TO" \
           --upgrade-charm-channel edge \
           --cloud "$JUJU_CLOUD" \
           --model "$JUJU_MODEL" \
           --controller "$JUJU_CONTROLLER"

    after-script:
      - python3 jobs/infra/collect-debug.py set-key 'snap_version' "$SNAP_VERSION"
      - python3 jobs/infra/collect-debug.py set-key 'to_snap_version' "$SNAP_VERSION_UPGRADE_TO"
      - python3 jobs/infra/collect-debug.py set-key 'is_upgrade' "yes"
      - !include jobs/spec-helpers/collect.yml
      - juju destroy-controller -y --destroy-all-models --destroy-storage $JUJU_CONTROLLER

  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.15/stable
      - SNAP_VERSION_UPGRADE_TO=1.17/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=stable
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-upgrade
      - JUJU_MODEL=validate-model
  - <<: *BASE_JOB
    env:
      - SNAP_VERSION=1.16/stable
      - SNAP_VERSION_UPGRADE_TO=1.17/edge
      - JUJU_DEPLOY_BUNDLE=cs:~containers/charmed-kubernetes
      - JUJU_DEPLOY_CHANNEL=stable
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=validate-ck-upgrade
      - JUJU_MODEL=validate-model

meta:
  name: Verify CK with minor upgrade
  description: |
    Verifies that CK minor upgrades from previous stable to upcoming edge passes integration tests
  mkdocs:
    destination:
      - "validations/ck/minor-upgrade.md"
    jenkins-job-builder:
      jobs:
        - jobs/ci-master.yaml
        - jobs/build-charms.yaml
