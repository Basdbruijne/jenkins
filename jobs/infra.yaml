# Jenkins maintainer jobs

- project:
    name: infra
    arch: ['amd64-1', 'amd64-2', 's390x', 'arm64', 'ppc64le']
    jobs:
      - 'infra-maintain-nodes-{arch}'

- job-template:
    name: 'infra-maintain-nodes-{arch}'
    description: |
      Keeps jenkins slave {arch} nodes configured properly.
    node: runner-{arch}
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    triggers:
        - timed: "0 */6 * * *"
    properties:
      - block-on-build-release
      - build-discarder:
          num-to-keep: 1
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/infra"
      - run-venv:
          COMMAND: |
            bash $WORKSPACE/jobs/infra/fixtures/cleanup-env.sh
      - shell: |
          #!/bin/bash
          set -eux
          set -o allexport
          [[ -f $WORKSPACE/.env ]] && source $WORKSPACE/.env
          set +o allexport

          TOX_WORK_DIR=.tox tox -e ansible

- job:
    name: 'infra-maintain-nodes-s390x-2'
    description: |
      Keeps jenkins slave nodes configured properly.
    node: runner-s390x
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    wrappers:
      - default-job-wrapper
      - ci-creds
    triggers:
        - timed: "0 */6 * * *"
    properties:
      - block-on-build-release
      - build-discarder:
          num-to-keep: 1
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/infra"
      - shell: |
          tee cleanup.sh <<EOF> /dev/null
          #!/bin/bash -x
          for i in $(juju controllers --format json | jq -r '.controllers | keys[]'); do
              if [ "$i" != "jaas" ]; then
                  echo "$i"
                  if ! timeout 2m juju destroy-controller -y --destroy-all-models --destroy-storage "$i"; then
                      timeout 2m juju kill-controller -y "$i" 2>&1
                  fi
              fi
          done
          for cntr in $(sudo lxc list --format json | jq -r ".[] | .name"); do
              echo "Removing $cntr"
              sudo lxc delete --force "$cntr"
          done

          for cntr in $(sudo lxc profile list --format json | jq -r ".[] | .name"); do
              if [[ $cntr != "default" ]]; then
                  echo "Removing $cntr"
                  sudo lxc profile delete "$cntr"
              fi
          done
          EOF
          scp -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /var/lib/jenkins/.ssh/cdkbot_rsa cleanup.sh  ubuntu@10.13.6.3:cleanup.sh
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /var/lib/jenkins/.ssh/cdkbot_rsa -tt ubuntu@10.13.6.3 -- bash cleanup.sh
