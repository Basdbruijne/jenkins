# Builds and releases charms

- job:
    name: 'promote-charms'
    description: |
      Promotes all charms from channel -> to channel
    node: runner-cloud
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    parameters:
      - string:
          name: FILTER_BY_TAG
          default: 'k8s'
      - string:
          name: FROM_CHANNEL
          default: 'edge'
      - string:
          name: TO_CHANNEL
          default: 'beta'
      - string:
          name: CHARM_LIST
          default: "jobs/includes/charm-support-matrix.inc"
    properties:
      - build-discarder:
          num-to-keep: 3
    wrappers:
      - default-job-wrapper
      - ci-creds
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/build-charms"
      - run-venv:
          JOB_SPEC_DIR: "jobs/build-charms"
          COMMAND: |
            #!/bin/bash
            set -eux
            python jobs/build-charms/charms.py promote \
                --from-channel $FROM_CHANNEL \
                --to-channel $TO_CHANNEL \
                --charm-list $CHARM_LIST \
                --filter-by-tag $FILTER_BY_TAG

# Builds and releases latest bundles
- job:
    name: 'promote-bundles'
    description: |
      Promotes bundles from channel -> to channel
    node: runner-cloud
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    parameters:
      - string:
          name: FILTER_BY_TAG
          default: 'k8s'
      - string:
          name: FROM_CHANNEL
          default: 'edge'
      - string:
          name: TO_CHANNEL
          default: 'beta'
      - string:
          name: BUNDLE_LIST
          default: "jobs/includes/charm-bundles-list.inc"
    properties:
      - build-discarder:
          num-to-keep: 3
    wrappers:
      - default-job-wrapper
      - ci-creds
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/build-charms"
      - run-venv:
          JOB_SPEC_DIR: "jobs/build-charms"
          COMMAND: |
            #!/bin/bash
            set -eux
            python jobs/build-charms/charms.py promote \
                --to-channel $TO_CHANNEL \
                --from-channel $FROM_CHANNEL \
                --charm-list $BUNDLE_LIST \
                --filter-by-tag $FILTER_BY_TAG

- job:
    name: 'build-charms'
    node: runner-amd64
    project-type: freestyle
    scm:
      - k8s-jenkins-jenkaas
    parameters:
      - charm-params
    triggers:
        - timed: "@daily"
    wrappers:
      - default-job-wrapper
      - ci-creds
    builders:
      - set-env:
          JOB_SPEC_DIR: "jobs/build-charms"
      - shell: |
          #!/bin/bash
          set -eux
          set -o allexport
          [[ -f $WORKSPACE/.env ]] && source $WORKSPACE/.env
          set +o allexport

          python3.8 -m venv venv
          venv/bin/python -m pip install ansible wheel sh semver click
          bin/lxd-launcher teardown --container-name charm-build || true
          bin/lxd-launcher build \
              --container-name charm-build \
              --playbook jobs/build-charms/playbook.yml
          sudo lxc exec charm-build -- bash -c "/root/jenkins/run.sh"
          bin/lxd-launcher teardown --container-name charm-build

