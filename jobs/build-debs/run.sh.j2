#!/bin/bash

set -x

export GIT_SSH_COMMAND='ssh -i /root/.ssh/cdkbot_rsa -oStrictHostKeyChecking=no'
export CDKBOT_GH_USR="{{ lookup('env', 'CDKBOT_GH_USER') }}"
export CDKBOT_GH_PSW="{{ lookup('env', 'CDKBOT_GH_PSW') }}"
export DEBEMAIL="Kubernetes Engineering <k8s-team-ci@canonical.com>"
K8S_VERSION="{{ lookup('env', 'K8S_VERSION') }}"
INCLUDE_SOURCE="{{ lookup('env', 'K8S_INCLUDE_SOURCE') }}"
K8STEAMCI_GPG_KEY="{{ lookup('env', 'K8STEAMCI_GPG_KEY') }}"

OPTS="--version $K8S_VERSION --sign-key $K8STEAMCI_GPG_KEY"

INCLUDE_SOURCE_FLAG=""
if [ "$INCLUDE_SOURCE" = "true" ]; then
    OPTS="$OPTS --include-source"
fi

cd /root/jenkins
pip3 install -rjobs/build-debs/requirements.txt
PYTHONPATH=. python3 jobs/build-debs/deb.py build-debs $OPTS
